<!DOCTYPE html>

<head>
  <script src="../../help.js"></script>
  <!-- <script src='graph.js'></script> -->
  <script src='astar.js'></script>
  <style>
    pre {
      /* font-size: 4px; */

    }

    .highlight {
      background: greenyellow;
      color: black;
    }
  </style>
</head>

<body style="background:#333;color:aliceblue;">
  <pre>check console</pre>
</body>
<script>
  "use strict";

  const input =
    `################################
######......###...##..##########
######....#G###G..##.G##########
#####...G##.##.........#########
##....##..#.##...........#######
#....#G.......##.........G.#####
##..##GG....G.................##
##.......G............#.......##
###.....G.....G#......E.......##
##......##....................##
#.....####......G.....#...######
#.#########.G....G....#E.#######
###########...#####......#######
###########..#######..E.......##
###########.#########......#.###
########..#.#########.........##
#######G....#########........###
##.##.#.....#########...EE#..#.#
#...GG......#########.#...##..E#
##...#.......#######..#...#....#
###.##........#####......##...##
###.........................#..#
####.............##........###.#
####............##.........#####
####..##....###.#...#.....######
########....###..............###
########..G...##.###...E...E.###
#########...G.##.###.E....E.####
#########...#.#######.......####
#############..########...######
##############.########.########
################################`

  const testInput =
    `#########
#G..G..G#
#.......#
#.......#
#G..E..G#
#.......#
#.......#
#G..G..G#
#########`   ;


  const inputToArray = str =>
    str
      .split('\n')
      .map(line => line.trim())
      .map(line => line.split(""));

  const readOrderSort = (a, b) =>
    a.y - b.y !== 0 ? a.y - b.y : a.x - b.x;

  /*
  looks like:
  3 3 3 3 3 3
  2 2 2 2 2 2
  1 1 1 1 1 1
  2 2 2 2 2 2
  3 3 3 3 3 3
  4 4 4 4 4 4
  */
  const getAstarGraphBetweenPositions = (arr, pos1, pos2) => {
    const lowerY = pos1.y < pos2.y ? pos1.y : pos2.y;
    return new Graph(arr.map((line, y) =>
      line.map((char, x) =>
        char === "." ? (Math.abs(lowerY - y) + 1) :
          (x === pos2.x && y === pos2.y) ? 1 :
            0)));

  }

  const getAdjacentEnemy = (subjects, pos1, actorType) => {
    const adjacentEnemies =
      subjects
        .filter(otherSub =>
          otherSub.char !== actorType &&
          otherSub.y >= pos1.y - 1 &&
          otherSub.y <= pos1.y + 1)
        .filter(otherSub =>
          otherSub.x >= pos1.x - 1 &&
          otherSub.x <= pos1.x + 1)
        .filter(otherSub =>
          otherSub.x === pos1.x ?
            (otherSub.y === pos1.y - 1 || otherSub.y === pos1.y + 1) :
            (otherSub.y === pos1.y))

    return adjacentEnemies.length ?
      adjacentEnemies.sort(readOrderSort)[0] : null;

    // const adjacentEnemies = find4(pos1.x, pos1.y, arr, actorType === "E" ? "G" : "E")
    // if (adjacentEnemies.length) {
    //   return adjacentEnemies
    //     .sort(readOrderSort)[0];
    // }
    // else
    //   return null;
  };

  const getShortestPathBetween = (map, subjects, pos1, pos2) => {
    const arr =
      map.map((line, y) =>
        line.map((char, x) => {
          const currentSub =
            subjects.find(sub => sub.x === x && sub.y === y);
          if (currentSub)
            return currentSub.char;
          else
            return char;
        }))
    const graph =
      getAstarGraphBetweenPositions(arr, pos1, pos2);
    return astar.search(
      graph,
      graph.grid[pos1.y][pos1.x],
      graph.grid[pos2.y][pos2.x])
  }

  const parseMap = arr =>
    arr
      .split("\n")
      .map(line => line.split(""))
      .map((line, y) =>
        line
          .map(char => char === "." || char === "#" ? char : "."));

  const parseSubjects = arr => {
    const subjects = [];
    arr.forEach((line, y) =>
      line.forEach((char, x) =>
        (char === "." || char === "#") ? null :
          subjects.push({ x: x, y: y, char: char, hp: 200 })))
    return subjects;
  }

  const advanceTick = (arr, subjects, map, firstRun = true, step) => {
    if (firstRun)
      arr = [...arr.map(line => line)];
    if (step > 20)
      return subjects;
    subjects = subjects.sort(readOrderSort);
    subjects.forEach((subject, i) => {
      if (getAdjacentEnemy(subjects, subject, subject.char)) {

      }
      else {

        const nextStep = subjects
          //get enemies
          .filter(sub =>
            sub.char !== subject.char)
          //get distances
          .map(enemy =>
            getShortestPathBetween(map, subjects, subject, enemy))
          //astar gives paths in GridNodes, which have x instead of y and vice versa
          .map(path =>
            ({ x: path[0].y, y: path[0].x }))
          //sort first steps
          .sort(readOrderSort)[0];

        if (nextStep) {
          subject.x = nextStep.x;
          subject.y = nextStep.y;
        }

      }
      const mapClone = map.map(line => line.map(char => char))
      subjects.forEach(subject =>
        mapClone[subject.y][subject.x] = subject.char);
      console.log(mapClone.map(line => line.join("")).join("\n"))


      // console.log(
      //   subject.char,
      //   subjects
      //     //get enemies
      //     .filter(sub =>
      //       sub.char !== subject.char)
      //     //get distances
      //     .map(enemy =>
      //       getShortestPathBetween(arr, subject, enemy))
      //     //astar gives paths in GridNodes, which have x instead of y and vice versa
      //     .map(path =>
      //       ({ x: path[0].y, y: path[0].x }))
      //     //sort first steps
      //     .sort(readOrderSort)[0]
      // )
    })
    return advanceTick(
      arr,
      subjects,
      map,
      false,
      step + 1)
  }


  /*
  NOTICE:
  astar gives paths in GridNodes, which have x instead of y and vice versa
  */

  let startTime = new Date()
  const arrayForA = inputToArray(testInput);
  console.log(
    "A:",
    advanceTick(
      arrayForA,
      parseSubjects(arrayForA),
      parseMap(arrayForA.map(line => line.join("")).join("\n")),

    ),
    //,
    "time:",
    new Date() - startTime,
    "ms"
  )
  startTime = new Date()


  console.log(
    "B:",
    Blist,
    //,
    "time:",
    new Date() - startTime,
    "ms"
  )


</script>