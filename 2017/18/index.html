<head>
    <meta charset="utf-8">
</head>
<body><pre>check console</pre></body>
<script src="../help/help.js"></script>
<script>

"use strict"




const input = 
`set i 31
set a 1
mul p 17
jgz p p
mul a 2
add i -1
jgz i -2
add a -1
set i 127
set p 952
mul p 8505
mod p a
mul p 129749
add p 12345
mod p a
set b p
mod b 10000
snd b
add i -1
jgz i -9
jgz a 3
rcv b
jgz b -1
set f 0
set i 126
rcv a
rcv b
set p a
mul p -1
add p b
jgz p 4
snd a
set a b
jgz 1 3
snd b
set f 1
add i -1
jgz i -11
snd a
jgz f -16
jgz a -19`;

const testInput = 
`set a 1
add a 2
mul a a
mod a 5
snd a
set a 0
rcv a
jgz a -1
set a 1
jgz a -2`;



const getRegisters = input=>
    input
        .split("\n")
        .map(str=>str.split(" ")[1])
        .filter((item,i,arr)=>!arr.slice(i+1).includes(item)) //unique
        .filter(item=>isNaN(parseInt(item))) //remove non-letters
        .reduce((acc,next)=>(acc[next] = 0,acc),{})

const registers =Â 
    getRegisters(input)


const testRegisters= 
    getRegisters(testInput)

console.log(testRegisters,registers)

const mapInputToArray = input=>
    input
        .split("\n")
        .map(str=>({
            instruction:str.split(" ")[0],
            input1 : str.split(" ")[1],
            input2 : str.split(" ")[2],
        }))


console.log(mapInputToArray(input))


/*
snd X plays a sound with a frequency equal to the value of X.
set X Y sets register X to the value of Y.
add X Y increases register X by the value of Y.
mul X Y sets register X to the result of multiplying the value contained in register X by the value of Y.
mod X Y sets register X to the remainder of dividing the value contained in register X by the value of Y (that is, it sets X to the result of X modulo Y).
rcv X recovers the frequency of the last sound played, but only when the value of X is not zero. (If it is zero, the command does nothing.)
jgz X Y jumps with an offset of the value of Y, but only if the value of X is greater than zero. (An offset of 2 skips the next instruction, an offset of -1 jumps to the previous instruction, and so on.)
*/


const handleInstructions = (instructionArray,registerList,step,lastPlayedSound,recoverFlag)=>() =>{
    if(step >= instructionArray.length)
        return registerList;
    if(recoverFlag !== undefined)
        return lastPlayedSound;
    if(step === 0)
        registerList = {...registerList};

    const move = instructionArray[step];
    let newStep = step+1;
    switch(move.instruction){
        case("snd"):
            lastPlayedSound = registerList[move.input1];
            break;
        case("set"):
            if(registerList[move.input2] !== undefined)
                registerList[move.input1] = registerList[move.input2];
            else
                registerList[move.input1] = parseInt(move.input2);
            break;
        case("add"):
            if(registerList[move.input2] !== undefined)
                registerList[move.input1] += registerList[move.input2];
            else
                registerList[move.input1] += parseInt(move.input2);
            break;
        case("mul"):
            if(registerList[move.input2] !== undefined)
                registerList[move.input1] *= registerList[move.input2];
            else
                registerList[move.input1] *= parseInt(move.input2);
            break;
        case("mod"):
            if(registerList[move.input2] !== undefined)
                registerList[move.input1] = registerList[move.input1] % registerList[move.input2];
            else
                registerList[move.input1] = registerList[move.input1] % parseInt(move.input2);
            break;
        case("rcv"):
            if(registerList[move.input1] !== 0)
                recoverFlag = true;
            break;
        case("jgz"):
            if(registerList[move.input1] > 0)
                if(registerList[move.input2] !== undefined)
                    newStep = step+registerList[move.input2];
                else
                    newStep = step+parseInt(move.input2);
            break;
        default:
            console.warn("WARNING INPUT NOT CAUGHT IN INSTRUCTIONHANDLE");

    }
    return handleInstructions(instructionArray,registerList,newStep,lastPlayedSound,recoverFlag);
}

 
console.log(
    "A:",
    trampoline(handleInstructions(
        mapInputToArray(input),
        registers,
        0)))


</script>
